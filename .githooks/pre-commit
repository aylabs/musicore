#!/bin/sh
# Pre-commit hook - Run TypeScript type checking and Rust formatting on staged files

echo "ğŸ” Running pre-commit checks..."

# Check if any Rust files are staged
STAGED_RS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^backend/.*\.rs$' || true)

if [ -n "$STAGED_RS_FILES" ]; then
  echo "ğŸ¦€ Rust files changed, running cargo fmt check..."
  
  cd backend
  
  if ! cargo fmt -- --check > /dev/null 2>&1; then
    echo "âŒ Rust formatting errors found! Run 'cargo fmt' in backend/ to fix."
    echo ""
    echo "Tip: Fix formatting or use 'git commit --no-verify' to skip this check."
    exit 1
  fi
  
  echo "âœ… Rust formatting check passed"

  echo "ğŸ” Running cargo clippy..."
  if ! cargo clippy -- -D warnings 2>&1 | tail -5; then
    echo "âŒ Clippy warnings found! Run 'cargo clippy -- -D warnings' in backend/ to see details."
    echo ""
    echo "Tip: Fix warnings or use 'git commit --no-verify' to skip this check."
    exit 1
  fi

  echo "âœ… Clippy check passed"
  cd ..
fi

# Check if any frontend TypeScript files are staged
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^frontend/src/.*\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  echo "ğŸ“ TypeScript files changed, running type check..."
  
  cd frontend
  
  # Run TypeScript compiler in check mode
  if ! npm run build > /dev/null 2>&1; then
    echo "âŒ TypeScript errors found! Run 'npm run build' in frontend/ to see details."
    echo ""
    echo "Tip: Fix errors or use 'git commit --no-verify' to skip this check."
    exit 1
  fi
  
  echo "âœ… TypeScript check passed"
  
  # Run ESLint
  echo "ğŸ” Running ESLint..."
  if ! npm run lint > /dev/null 2>&1; then
    echo "âŒ ESLint errors found! Run 'npm run lint' in frontend/ to see details."
    echo ""
    echo "Tip: Fix errors with 'npm run lint -- --fix' or use 'git commit --no-verify' to skip."
    exit 1
  fi
  
  echo "âœ… ESLint passed"
  cd ..
fi

echo "âœ… Pre-commit checks passed"
exit 0
